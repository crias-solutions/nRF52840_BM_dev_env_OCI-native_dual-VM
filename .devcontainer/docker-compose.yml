version: '3.8'

services:
  build-server:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: nrf52840-build-server
    volumes:
      - ../firmware:/workspace/nrf52840_project
      - build-cache:/workspace/nRF5_SDK
    working_dir: /workspace/nrf52840_project
    command: sleep infinity
    privileged: true
    
  hardware-gateway:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: nrf52840-hardware-gateway
    ports:
      - "3240:3240"
    devices:
      - /dev/bus/usb:/dev/bus/usb
    privileged: true
    command: bash -c "modprobe vhci-hcd && usbip attach -r host.docker.internal -b 3-1 && sleep infinity"

volumes:
  build-cache:
